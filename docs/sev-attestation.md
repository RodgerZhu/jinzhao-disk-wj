## Attestation Flow

- The Guest Owner launches a new SEV-SNP guest instance.
- The Guest Owner creates any new users and copies the Guest Owner's SSH public key to the new users' SSH `authorized_keys` file.
- The Guest Owner generates SSH host keypairs to identify the guest, and passes the public portion of the host SSH key to the sev-guest utility along with the Guest Owner's public key for inclusion in the attestation report.
- The sev-guest utility issues the `SNP_GET_REPORT` (or `SNP_GET_EXT_REPORT`) IOCTL to the `sevguest.ko` kernel driver to retrieve the attestation report from the ASP firmware.
- The `sevguest.ko` kernel driver encrypts and integrity-protects the `MSG_REPORT_REQ` guest message with a key that was placed into guest memory by the ASP during launch, then exits to the hypervisor. The key is known only to the guest and the ASP firmware, so the hypervisor cannot view or modify the guest message in transit.
- The hypervisor sends the `SNP_GUEST_REQUEST` command (with the `MSG_REPORT_REQ` payload) to the ASP firmware.
- The hypervisor relays the response back through the `sevguest.ko` driver, and the sev-guest utility returns the attestation report to the Guest Owner.

The Guest Owner verifies the SNP attestation report with the following series of checks:

- The signature of the report verifies correctly using the public portion of the VCEK.
- The signature of the VCEK verifies correctly using the public portion of the AMD Signing Key (ASK).
- The signature of the ASK verifies correctly using the public portion of the AMD Root Key (ARK).
- The ARK is self-signed.
- The hash of the public keys included in the attestation report matches the expected value.

After the attestation report is verified, the Guest Owner can SSH to the guest VM.

## Guest Identity

In the SEV-SNP architecture, the identity of the guest instance is established by the ID Block, which contains the public portion of a key pair that identifies the Guest Owner. This key is called the ID key. The ID block also contains the expected launch measurement of the guest instance. This ID block is copied into guest memory by the SEV-SNP firmware during the launch sequence and binds the Guest Owner's identity to that guest instance. If the ID block is present for a guest instance, then the attestation report generated by the SEV-SNP firmware will contain the hash of the ID key as well as the expected launch measurement. In this way, the attestation report attests to both the identity of the guest instance as well as the launch integrity.

This example does not yet configure the ID block when launching the guest, so the ID key and the launch measurement are currently set to 0 in the attestation report. As such, they are not checked by the Guest Owner. To realize the full security promise of SEV-SNP, production environments must configure these fields during launch. Similarly, Guest Owners should validate these fields in the attestation report in addition to the checks listed above. Future updates to this repository will demonstrate how to do this.
